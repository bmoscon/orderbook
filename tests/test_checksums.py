
'''
Copyright (C) 2020-2024  Bryant Moscon - bmoscon@gmail.com

Please see the LICENSE file for the terms and conditions
associated with this software.
'''
from decimal import Decimal

import pytest

from order_book import OrderBook


def test_minimum_depth_kraken():
    ob = OrderBook(max_depth=9, checksum_format='KRAKEN')
    with pytest.raises(ValueError):
        ob.checksum()


def test_kraken_checksum():
    # This checksum is from the kraken docs
    ob = OrderBook(max_depth=10, checksum_format='KRAKEN')
    asks = [
        ["0.05005", "0.00000500", "1582905487.684110"],
        ["0.05010", "0.00000500", "1582905486.187983"],
        ["0.05015", "0.00000500", "1582905484.480241"],
        ["0.05020", "0.00000500", "1582905486.645658"],
        ["0.05025", "0.00000500", "1582905486.859009"],
        ["0.05030", "0.00000500", "1582905488.601486"],
        ["0.05035", "0.00000500", "1582905488.357312"],
        ["0.05040", "0.00000500", "1582905488.785484"],
        ["0.05045", "0.00000500", "1582905485.302661"],
        ["0.05050", "0.00000500", "1582905486.157467"]
    ]

    bids = [
        ["0.05000", "0.00000500", "1582905487.439814"],
        ["0.04995", "0.00000500", "1582905485.119396"],
        ["0.04990", "0.00000500", "1582905486.432052"],
        ["0.04980", "0.00000500", "1582905480.609351"],
        ["0.04975", "0.00000500", "1582905476.793880"],
        ["0.04970", "0.00000500", "1582905486.767461"],
        ["0.04965", "0.00000500", "1582905481.767528"],
        ["0.04960", "0.00000500", "1582905487.378907"],
        ["0.04955", "0.00000500", "1582905483.626664"],
        ["0.04950", "0.00000500", "1582905488.509872"]
    ]

    for a in asks:
        ob.asks[Decimal(a[0])] = Decimal(a[1])

    for b in bids:
        ob.bids[Decimal(b[0])] = Decimal(b[1])

    assert ob.checksum() == 974947235

    # The following checksums are from recorded data
    ob = OrderBook(max_depth=11, checksum_format='KRAKEN')

    asks = [
        ["0.620000", "40.00000000"],
        ["0.830000", "380.86649128"],
        ["1.500000", "333.33333333"]
    ]

    bids = [
        ["0.520300", "3943.09454867"],
        ["0.403200", "454.31671175"],
        ["0.403100", "1522.68122054"],
        ["0.403000", "43.31058726"],
        ["0.353200", "49.38467346"],
        ["0.261600", "66.67686034"],
        ["0.111000", "99.09909910"],
        ["0.110000", "909.09090909"],
        ["0.000600", "3333.33333333"],
        ["0.000400", "5000.00000000"],
        ["0.000100", "1000000.00000000"]
    ]

    for a in asks:
        ob.asks[Decimal(a[0])] = Decimal(a[1])

    for b in bids:
        ob.bids[Decimal(b[0])] = Decimal(b[1])

    assert ob.checksum() == 577149452

    ob = OrderBook(max_depth=11, checksum_format='KRAKEN')

    asks = [
        ["0.814900", "297.71298000"],
        ["0.815000", "500.00000000"],
        ["0.815100", "500.00399385"],
        ["0.815200", "42.03000000"],
        ["0.815300", "21.50000000"],
        ["0.815400", "10.75000000"],
        ["0.829900", "1442.34063708"],
        ["0.830000", "380.86649128"],
        ["1.500000", "333.33333333"]
    ]

    bids = [
        ["0.473400", "1284.67569684"],
        ["0.441000", "40.00415721"],
        ["0.342200", "51.43191116"],
        ["0.261600", "66.92596839"],
        ["0.111000", "99.09909910"],
        ["0.110000", "909.09090909"],
        ["0.000600", "3333.33333333"],
        ["0.000400", "5000.00000000"],
        ["0.000100", "1000000.00000000"]
    ]

    for a in asks:
        ob.asks[Decimal(a[0])] = Decimal(a[1])

    for b in bids:
        ob.bids[Decimal(b[0])] = Decimal(b[1])

    assert ob.checksum() == 2369158246

    ob = OrderBook(max_depth=11, checksum_format='KRAKEN')

    asks = [
        ["0.000017680", "38663.54992198"],
        ["0.000017690", "20623.74841086"],
        ["0.000017700", "103797.62636430"],
        ["0.000017710", "40745.97057228"],
        ["0.000017720", "13296.04740856"],
        ["0.000017730", "42078.86085768"],
        ["0.000017740", "64.38065876"],
        ["0.000017760", "1131.70427847"],
        ["0.000017780", "43891.46024565"],
        ["0.000017790", "43908.00000000"],
        ["0.000017810", "0.00005437"]
    ]

    bids = [
        ["0.000017670", "0.00000048"], # small volume causes scientific notation
        ["0.000017660", "50.29884341"],
        ["0.000017650", "16958.37856622"],
        ["0.000017640", "16735.08043085"],
        ["0.000017630", "61895.21671233"],
        ["0.000017620", "86958.66158205"],
        ["0.000017610", "8564.64738216"],
        ["0.000017600", "59539.93801826"],
        ["0.000017580", "52578.63046424"],
        ["0.000017570", "46812.60266777"],
        ["0.000017560", "640.09877588"]
    ]

    for a in asks:
        ob.asks[Decimal(a[0])] = Decimal(a[1])

    for b in bids:
        ob.bids[Decimal(b[0])] = Decimal(b[1])

    assert ob.checksum() == 1611253991

    ob = OrderBook(checksum_format='KRAKEN')
    assert ob.checksum() == 0


def test_okx_checksum():
    ob = OrderBook(checksum_format='OKX')

    asks = {Decimal("3366.8"): Decimal("9"), Decimal("3368"): Decimal("8"), Decimal("3372"): Decimal("8")}
    bids = {Decimal("3366.1"): Decimal("7")}

    ob.bids = bids
    ob.asks = asks

    assert ob.checksum() == 831078360

    ob = OrderBook(checksum_format='OKX')

    asks = [
        ["28923.3", "1.87800235"],
        ["28923.4", "0.04"],
        ["28924.3", "0.06867412"],
        ["28925.6", "0.09861686"],
        ["28925.8", "0.16453656"],
        ["28925.9", "2.23"],
        ["28926", "0.32274814"],
        ["28926.1", "0.6232534"],
        ["28926.4", "1.04"],
        ["28926.8", "0.01707781"],
        ["28928.5", "0.07061975"],
        ["28929", "0.144"],
        ["28930.2", "0.1"],
        ["28930.3", "6.40922866"],
        ["28931.9", "0.54902396"],
        ["28932", "0.17306693"],
        ["28932.7", "2.5672"],
        ["28932.8", "1.19528238"],
        ["28932.9", "0.05"],
        ["28933", "0.34194526"],
        ["28933.5", "0.02319626"],
        ["28933.6", "0.764"],
        ["28933.7", "0.01"],
        ["28934.4", "0.05"],
        ["28935", "0.0115"],
        ["28935.1", "0.48"],
        ["28935.8", "0.00696447"],
        ["28935.9", "0.144"],
        ["28936", "0.12700417"],
        ["28936.5", "1.58799999"]
    ]

    bids = [
        ["28923.2", "0.0000001"],
        ["28923", "0.49101312"],
        ["28922.4", "0.01251868"],
        ["28921.2", "0.00020273"],
        ["28920.9", "0.00009315"],
        ["28920.3", "0.00008106"],
        ["28920", "0.03448414"],
        ["28919.6", "0.00002087"],
        ["28919.3", "0.00026015"],
        ["28919", "0.0000519"],
        ["28917.7", "0.00014609"],
        ["28916.7", "0.00002008"],
        ["28915.9", "0.00009415"],
        ["28915", "0.0454951"],
        ["28914.6", "0.007"],
        ["28914.3", "0.12709954"],
        ["28913.7", "0.0060879"],
        ["28913.6", "0.00342"],
        ["28913.3", "0.00574477"],
        ["28911.8", "0.00106132"],
        ["28911.1", "0.00011083"],
        ["28911", "0.00008173"],
        ["28910", "0.0006918"],
        ["28909.9", "0.06897"],
        ["28909.8", "0.00975481"],
        ["28909.6", "0.00001002"],
        ["28909", "0.00134995"],
        ["28908.5", "0.00796815"],
        ["28908.4", "0.17308796"],
        ["28908.1", "0.67728285"]
    ]

    for a in asks:
        ob.asks[Decimal(a[0])] = Decimal(a[1])

    for b in bids:
        ob.bids[Decimal(b[0])] = Decimal(b[1])

    assert ob.checksum() == 2399502091

    ob = OrderBook(checksum_format='OKX')
    assert ob.checksum() == 0


def test_bitget_checksum():
    ob = OrderBook(checksum_format='BITGET')

    asks = [
        ["0.000000001461", "3422313485"],
        ["0.000000001462", "174253432795"],
        ["0.000000001465", "530000463264"],
        ["0.000000001466", "799507026717"],
        ["0.000000001467", "458580845176"],
        ["0.000000001468", "1300000000000"],
        ["0.000000001470", "29814639074"],
        ["0.000000001471", "6904159343"],
        ["0.000000001472", "71139049304"],
        ["0.000000001473", "5735877536"],
        ["0.000000001474", "3392130259"],
        ["0.000000001475", "3389830509"],
        ["0.000000001476", "81662587311"],
        ["0.000000001477", "9142169664"],
        ["0.000000001479", "87063042280"],
        ["0.000000001480", "7035327151"],
        ["0.000000001481", "193948520465"],
        ["0.000000001482", "36857236128"],
        ["0.000000001486", "3364737551"],
        ["0.000000001487", "94365814068"],
        ["0.000000001488", "7047935390"],
        ["0.000000001489", "3357958362"],
        ["0.000000001490", "23979201076"],
        ["0.000000001491", "3353454059"],
        ["0.000000001492", "3351206435"],
        ["0.000000001493", "34245570920"],
        ["0.000000001495", "3344481606"],
        ["0.000000001496", "3342245990"],
        ["0.000000001497", "5928111901"],
        ["0.000000001498", "536314945995"]
    ]

    bids = [
        ["0.000000001452", "26041231119"],
        ["0.000000001451", "765679503030"],
        ["0.000000001450", "24988603767"],
        ["0.000000001449", "1138718088876"],
        ["0.000000001447", "12557585692"],
        ["0.000000001446", "53377804919"],
        ["0.000000001445", "3460207613"],
        ["0.000000001444", "499764868141"],
        ["0.000000001443", "523229389780"],
        ["0.000000001442", "972284349540"],
        ["0.000000001441", "3469812631"],
        ["0.000000001440", "24023644819"],
        ["0.000000001439", "34783252746"],
        ["0.000000001438", "3477051461"],
        ["0.000000001437", "96154818726"],
        ["0.000000001436", "3481894151"],
        ["0.000000001435", "436716489370"],
        ["0.000000001433", "801993699520"],
        ["0.000000001432", "1242648129244"],
        ["0.000000001431", "79364670199"],
        ["0.000000001429", "163983130634"],
        ["0.000000001428", "68235008969"],
        ["0.000000001426", "179767647586"],
        ["0.000000001425", "1300000000000"],
        ["0.000000001424", "1300000000000"],
        ["0.000000001423", "75814709870"],
        ["0.000000001421", "164996453397"],
        ["0.000000001420", "16901408450"],
        ["0.000000001419", "58875214144"],
        ["0.000000001418", "4612402959"]
    ]

    for a in asks:
        ob.asks[Decimal(a[0])] = Decimal(a[1])

    for b in bids:
        ob.bids[Decimal(b[0])] = Decimal(b[1])

    assert ob.checksum() == 3720106698

    ob = OrderBook(checksum_format='BITGET')
    assert ob.checksum() == 0


def test_okcoin_checksum():
    ob = OrderBook(checksum_format='OKCOIN')

    asks = {Decimal("3366.8"): Decimal("9"), Decimal("3368"): Decimal("8"), Decimal("3372"): Decimal("8")}
    bids = {Decimal("3366.1"): Decimal("7")}

    ob.bids = bids
    ob.asks = asks

    assert ob.checksum() == 831078360


def test_ftx_checksum():
    ob = OrderBook(checksum_format='FTX')

    asks = [
        ["0.003385", "142011.0"],
        ["0.003395", "221850.0"],
        ["0.0034", "120.0"],
        ["0.003405", "149119.0"],
        ["0.003415", "3.0"],
        ["0.003425", "46851.0"],
        ["0.00343", "162552.0"],
        ["0.003445", "3.0"],
        ["0.003455", "182323.0"],
        ["0.003465", "123.0"],
        ["0.003475", "171058.0"],
        ["0.00348", "4.0"],
        ["0.0035", "3.0"],
        ["0.003515", "3.0"],
        ["0.00352", "17.0"],
        ["0.00353", "120.0"],
        ["0.003535", "3.0"],
        ["0.00355", "196293.0"],
        ["0.003565", "168196.0"],
        ["0.00357", "4.0"],
        ["0.003585", "3.0"],
        ["0.003595", "120.0"],
        ["0.003605", "3.0"],
        ["0.00361", "1.0"],
        ["0.003615", "354598.0"],
        ["0.00362", "3.0"],
        ["0.003635", "5.0"],
        ["0.00364", "181628.0"],
        ["0.00365", "4.0"],
        ["0.003655", "3.0"],
        ["0.00366", "121.0"],
        ["0.003675", "8.0"],
        ["0.00368", "202178.0"],
        ["0.00369", "3.0"],
        ["0.0037", "179932.0"],
        ["0.00371", "295577.0"],
        ["0.003725", "123.0"],
        ["0.003745", "3.0"],
        ["0.00375", "1.0"],
        ["0.00376", "3.0"],
        ["0.003775", "208662.0"],
        ["0.00378", "3.0"],
        ["0.00379", "120.0"],
        ["0.003795", "3.0"],
        ["0.0038", "1.0"],
        ["0.003815", "3.0"],
        ["0.003825", "16.0"],
        ["0.00383", "3.0"],
        ["0.00385", "4.0"],
        ["0.003855", "120.0"],
        ["0.003865", "3.0"],
        ["0.003885", "3.0"],
        ["0.00389", "1.0"],
        ["0.0039", "876.0"],
        ["0.00392", "123.0"],
        ["0.003935", "3.0"],
        ["0.00394", "1.0"],
        ["0.003955", "3.0"],
        ["0.00397", "3.0"],
        ["0.00398", "5.0"],
        ["0.003985", "120.0"],
        ["0.00399", "4.0"],
        ["0.004005", "3.0"],
        ["0.00402", "3.0"],
        ["0.00403", "3.0"],
        ["0.00405", "120.0"],
        ["0.00406", "3.0"],
        ["0.00409", "3.0"],
        ["0.004115", "120.0"],
        ["0.00412", "3.0"],
        ["0.004135", "5.0"],
        ["0.00414", "1764.0"],
        ["0.00415", "3.0"],
        ["0.00418", "123.0"],
        ["0.00421", "3.0"],
        ["0.00424", "3.0"],
        ["0.004245", "120.0"],
        ["0.00427", "3.0"],
        ["0.00429", "16.0"],
        ["0.0043", "3.0"],
        ["0.00431", "120.0"],
        ["0.00433", "3.0"],
        ["0.00436", "3.0"],
        ["0.004375", "120.0"],
        ["0.00439", "3.0"],
        ["0.00442", "3.0"],
        ["0.00443", "147145.0"],
        ["0.00444", "120.0"],
        ["0.004445", "16.0"],
        ["0.00445", "3.0"],
        ["0.00448", "3.0"],
        ["0.004505", "120.0"],
        ["0.004515", "3.0"],
        ["0.004545", "3.0"],
        ["0.00457", "120.0"],
        ["0.004575", "3.0"],
        ["0.004595", "16.0"],
        ["0.004605", "3.0"],
        ["0.004635", "123.0"],
        ["0.004665", "3.0"]
    ]

    bids = [
        ["0.00336", "3.0"],
        ["0.00335", "39492.0"],
        ["0.003345", "3.0"],
        ["0.00334", "219821.0"],
        ["0.00333", "17115.0"],
        ["0.003325", "205654.0"],
        ["0.003315", "8049.0"],
        ["0.00331", "602.0"],
        ["0.00329", "4.0"],
        ["0.00328", "7.0"],
        ["0.003275", "509455.0"],
        ["0.00327", "120.0"],
        ["0.003265", "148571.0"],
        ["0.003255", "3.0"],
        ["0.00324", "4.0"],
        ["0.003235", "612.0"],
        ["0.00322", "148150.0"],
        ["0.003215", "169503.0"],
        ["0.00321", "16.0"],
        ["0.003205", "184421.0"],
        ["0.0032", "1.0"],
        ["0.003185", "3.0"],
        ["0.00317", "3.0"],
        ["0.00315", "8575.0"],
        ["0.003145", "247853.0"],
        ["0.003135", "3.0"],
        ["0.00312", "3060.0"],
        ["0.003115", "186021.0"],
        ["0.00311", "1.0"],
        ["0.003105", "229810.0"],
        ["0.0031", "3.0"],
        ["0.003095", "206811.0"],
        ["0.00308", "3.0"],
        ["0.003065", "3.0"],
        ["0.003055", "16.0"],
        ["0.003045", "3.0"],
        ["0.00303", "3.0"],
        ["0.00301", "288639.0"],
        ["0.003", "272946.0"],
        ["0.002995", "3.0"],
        ["0.002975", "212459.0"],
        ["0.002965", "244636.0"],
        ["0.00296", "3.0"],
        ["0.00294", "3.0"],
        ["0.002925", "3.0"],
        ["0.002905", "19.0"],
        ["0.00289", "3.0"],
        ["0.00287", "3.0"],
        ["0.002855", "3.0"],
        ["0.00284", "3.0"],
        ["0.00282", "3.0"],
        ["0.002805", "3.0"],
        ["0.002785", "3.0"],
        ["0.00277", "3.0"],
        ["0.00275", "3.0"],
        ["0.002735", "3.0"],
        ["0.002715", "3.0"],
        ["0.0027", "3.0"],
        ["0.00268", "3.0"],
        ["0.002665", "3.0"],
        ["0.002645", "3.0"],
        ["0.00263", "3.0"],
        ["0.00261", "3.0"],
        ["0.002595", "3.0"],
        ["0.002575", "3.0"],
        ["0.00256", "3.0"],
        ["0.002555", "147658.0"],
        ["0.00254", "3.0"],
        ["0.002525", "3.0"],
        ["0.002505", "3.0"],
        ["0.00249", "3.0"],
        ["0.00247", "3.0"],
        ["0.002455", "3.0"],
        ["0.002435", "3.0"],
        ["0.00242", "3.0"],
        ["0.0024", "3.0"],
        ["0.002385", "3.0"],
        ["0.002365", "3.0"],
        ["0.00235", "3.0"],
        ["0.00233", "3.0"],
        ["0.002315", "3.0"],
        ["0.0023", "3.0"],
        ["0.002035", "3440.0"],
        ["0.0015", "1333.0"],
        ["0.0012", "5010.0"],
        ["0.00033", "303030.0"],
        ["0.00003", "371115.0"]
    ]

    for a in asks:
        ob.asks[Decimal(a[0])] = Decimal(a[1])

    for b in bids:
        ob.bids[Decimal(b[0])] = Decimal(b[1])

    assert ob.checksum() == 3169411573

    ob = OrderBook(checksum_format='FTX')
    assert ob.checksum() == 0

